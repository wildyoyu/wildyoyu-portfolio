---
import { astroEvents } from '../data/events';

const now = new Date();
const year = now.getFullYear();
const month = now.getMonth() + 1;

function monthMatrix(y: number, m: number){
  const first = new Date(y, m-1, 1);
  const start = (first.getDay() + 6) % 7; // L=0
  const days = new Date(y, m, 0).getDate();
  const cells: Array<{d:number|null, iso?:string}> = [];
  for(let i=0;i<start;i++) cells.push({d:null});
  for(let d=1; d<=days; d++){
    const iso = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    cells.push({d, iso});
  }
  while(cells.length % 7) cells.push({d:null});
  return { cells };
}

const eventsJSON = JSON.stringify(astroEvents);
---
<section class="section" id="calendar">
  <div class="container">
    <h2 class="h2" style="margin-bottom:.6rem;">Calendario astronómico</h2>
    <div class="cal" data-year={year} data-month={month}>
      <header class="cal__hdr">
        <div class="cal__title"></div>
        <div class="cal__nav">
          <button class="btn cal__btn" data-nav="-1" aria-label="Mes anterior">‹</button>
          <button class="btn cal__btn" data-nav="+1" aria-label="Mes siguiente">›</button>
        </div>
      </header>
      <div class="cal__grid">
        <div class="cal__dow">L</div><div class="cal__dow">M</div><div class="cal__dow">X</div>
        <div class="cal__dow">J</div><div class="cal__dow">V</div><div class="cal__dow">S</div><div class="cal__dow">D</div>
        <!-- celdas se rellenan por JS -->
      </div>
      <div class="cal__legend">
        <span><i class="cal__badge t-luna"></i> Luna</span>
        <span><i class="cal__badge t-lluvia"></i> Lluvia</span>
        <span><i class="cal__badge t-planeta"></i> Planeta</span>
        <span><i class="cal__badge t-eclipse"></i> Eclipse</span>
        <span><i class="cal__badge t-otro"></i> Otro</span>
      </div>
      <div class="cal__list">
        <h3 class="h2" style="font-size:18px; margin:.8rem 0 .4rem">Próximos</h3>
        <ul class="cal__upcoming"></ul>
      </div>
    </div>
  </div>

  <script is:inline >
    window.__ASTRO_EVENTS__ = /*json*/ {eventsJSON.replace(/</g,'\\u003c')};
  </script>

  <style>
    .cal{display:grid; gap:10px; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px}
    .cal__hdr{display:flex; align-items:center; justify-content:space-between}
    .cal__title{text-transform:capitalize; font-weight:900; letter-spacing:.3px}
    .cal__btn{padding:.2rem .6rem}
    .cal__grid{display:grid; grid-template-columns:repeat(7,1fr)}
    .cal__dow, .cal__cell{
      border-top:1px solid rgba(255,255,255,.08);
      border-left:1px solid rgba(255,255,255,.08);
      min-height:64px; display:grid; align-content:start; padding:6px;
    }
    .cal__dow:nth-child(7n), .cal__cell:nth-child(7n){ border-right:1px solid rgba(255,255,255,.08) }
    .cal__cell:last-child{ border-bottom:1px solid rgba(255,255,255,.08) }
    .cal__dow{ text-align:center; align-content:center; opacity:.7; font-weight:700; min-height:36px }
    .cal__cell.is-empty{ background:linear-gradient(180deg, rgba(255,255,255,.03), transparent) }
    .cal__num{ font-weight:800; opacity:.95 }
    .cal__events{ display:flex; gap:4px; margin-top:auto; align-items:flex-end; min-height:14px }
    .cal__badge{ width:8px; height:8px; border-radius:999px; display:inline-block; border:1px solid rgba(255,255,255,.6) }
    .t-luna{ background:#dbeafe } .t-lluvia{ background:#fde68a } .t-planeta{ background:#c7f9cc } .t-eclipse{ background:#fecaca } .t-otro{ background:#e5e7eb }
    .cal__legend{display:flex; flex-wrap:wrap; gap:10px; opacity:.9; font-size:14px}
    .cal__list ul{margin:0; padding-left:18px}
  </style>

  <script is:inline>
    const CAL = document.querySelector('.cal');
    const GRID = CAL.querySelector('.cal__grid');
    const TITLE = CAL.querySelector('.cal__title');
    const UPC = CAL.querySelector('.cal__upcoming');
    const EVS = Array.isArray(window.__ASTRO_EVENTS__) ? window.__ASTRO_EVENTS__ : [];

    function monthMatrix(y, m){
      const first = new Date(y, m-1, 1);
      const start = (first.getDay() + 6) % 7;
      const days = new Date(y, m, 0).getDate();
      const cells = [];
      for(let i=0;i<start;i++) cells.push({d:null});
      for(let d=1; d<=days; d++){
        const iso = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        cells.push({d, iso});
      }
      while(cells.length % 7) cells.push({d:null});
      return cells;
    }

    function renderCalendar(y, m){
      CAL.dataset.year = y; CAL.dataset.month = m;
      const monthName = new Date(y, m-1, 1).toLocaleString('es-ES',{month:'long', year:'numeric'});
      TITLE.textContent = monthName;

      // limpia celdas previas (dejando cabecera de días)
      GRID.querySelectorAll('.cal__cell').forEach(n=>n.remove());

      const cells = monthMatrix(y,m);
      const byDay = new Map();
      EVS.forEach(ev => {
        const arr = byDay.get(ev.date) || [];
        arr.push(ev); byDay.set(ev.date, arr);
      });

      const frag = document.createDocumentFragment();
      cells.forEach(cell => {
        const div = document.createElement('div');
        div.className = 'cal__cell' + (cell.d ? '' : ' is-empty');
        if (cell.d){
          const num = document.createElement('div');
          num.className = 'cal__num'; num.textContent = String(cell.d);
          const evs = document.createElement('div');
          evs.className = 'cal__events';
          (byDay.get(cell.iso) || []).forEach(ev => {
            const i = document.createElement('div');
            i.className = 'cal__badge t-' + (ev.type || 'otro');
            i.title = ev.title;
            evs.appendChild(i);
          });
          div.appendChild(num); div.appendChild(evs);
        }
        frag.appendChild(div);
      });
      GRID.appendChild(frag);

      // próximos (a partir de hoy)
      const today = new Date(new Date().toDateString());
      UPC.innerHTML = EVS
        .filter(ev => new Date(ev.date) >= today)
        .sort((a,b)=> new Date(a.date) - new Date(b.date))
        .slice(0,8)
        .map(ev => `<li><strong>${new Date(ev.date).toLocaleDateString('es-ES',{day:'2-digit',month:'short'})}</strong> — ${ev.title}</li>`)
        .join('');
    }

    // navegación
    CAL.querySelectorAll('.cal__btn').forEach(btn => {
      btn.addEventListener('click', () => {
        let y = Number(CAL.dataset.year), m = Number(CAL.dataset.month);
        const diff = Number(btn.dataset.nav); // -1 o +1
        m += diff;
        if (m < 1){ m = 12; y--; }
        if (m > 12){ m = 1;  y++; }
        renderCalendar(y, m);
      });
    });

    renderCalendar(Number(CAL.dataset.year), Number(CAL.dataset.month));
  </script>
</section>
