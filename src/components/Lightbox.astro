---
/**
 * Visor (dialog) con:
 *  - ⤓ Ver entera (original) → nueva pestaña
 *  - ❤️ Like & ↗ Compartir
 *  - Carrusel horizontal si hay "srcs"
 *  - Abre en la miniatura pulsada (usa slug o índice)
 */
---
<dialog id="sheetviewer" class="sv" aria-label="Visor de imágenes">
  <div class="sv-backdrop" part="backdrop"></div>
  <div class="sv-sheet" role="document" aria-live="polite">
    <header class="sv-top">
      <button class="sv-close" aria-label="Cerrar" title="Cerrar">×</button>
    </header>
    <div class="sv-reel" tabindex="0" aria-live="polite"></div>
  </div>
</dialog>

<style>
  .sv{ inset:0; border:0; padding:0; background:transparent; }
  .sv[open]{ display:grid; place-items:center; }
  .sv::backdrop{ background:rgba(0,0,0,.65); }
  .sv-sheet{
    position:relative; width: clamp(320px, 46vw, 760px); height: 76vh;
    background: rgba(12,14,16,.92); backdrop-filter: blur(6px);
    border-radius: 18px; outline: 1px solid rgba(255,255,255,.08);
    box-shadow: 0 30px 100px rgba(0,0,0,.5);
    overflow: hidden; display:grid; grid-template-rows: auto 1fr;
  }
  @media (max-width: 900px){ .sv-sheet{ width:min(92vw, 920px); height:84vh; } }

  .sv-top{ display:flex; align-items:center; gap:8px; padding:10px;
    background: linear-gradient(180deg, rgba(0,0,0,.35), transparent); }
  .sv-close{
    min-width:42px; height:42px; padding:0 12px; border-radius:9999px;
    border:1px solid rgba(255,255,255,.2); background:rgba(0,0,0,.35); color:#fff;
    cursor:pointer; display:inline-flex; align-items:center; justify-content:center; backdrop-filter:blur(6px);
  }

  .sv-reel{
    height:100%; overflow-y:auto; overflow-x:hidden;
    scroll-snap-type:y mandatory; -webkit-overflow-scrolling:touch; overscroll-behavior-y:contain;
  }
  .sv-slide{
    min-height:100%; box-sizing:border-box; padding:clamp(10px,2vw,16px);
    scroll-snap-align:start; display:flex; align-items:center; justify-content:center;
  }

  .sv-figure{ width:min(92%, 960px); display:flex; flex-direction:column; gap:12px; flex:1; min-height:0; }

  .sv-view{ position:relative; flex:1; min-height:0; height: var(--imgH, 56vh); }
  .sv-single, .sv-hstrip{ width:100%; height:100%; }

  /* “Contain” fijo para que siempre quepa completa */
  .sv-single, .sv-hstrip{ display:grid; place-items:center; overflow:hidden; }
  .sv-single img,
  .sv-himg img{
    max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; display:block;
  }

  /* Carrusel horizontal */
  .sv-hstrip{ display:flex; gap:8px; overflow-x:auto; overflow-y:hidden; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; }
  .sv-himg{ flex:0 0 auto; height:100%; display:grid; place-items:center; scroll-snap-align:center; border-radius:10px; overflow:hidden; background:rgba(255,255,255,.03); outline:1px solid rgba(255,255,255,.06); }
  .sv-hstrip::-webkit-scrollbar{ display:none; }

  /* Pie blanco */
  .sv-caption{
    position: sticky; bottom: 0; width: 100%;
    background:#fff; color:#111; border-radius:12px; border:1px solid #e5e7eb;
    box-shadow: 0 12px 32px rgba(0,0,0,.25);
    display:flex; align-items:center; gap:8px; padding:10px 10px; z-index:5;
  }
  .cap-text{ min-width:0; flex:1; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#111; }
  .cap-actions{ display:flex; gap:8px; }
  .cap-btn{
    all:unset; box-sizing:border-box; width:40px; height:40px; border-radius:9999px;
    background:#fff; color:#111; border:1px solid #e5e7eb;
    display:grid; place-items:center; cursor:pointer; line-height:0;
  }
  .cap-btn svg{ width:22px; height:22px; display:block; }
  .cap-like.liked{ color:#e11d48; } .cap-like.liked svg{ fill:currentColor; }
</style>

<script is:inline>
  const dialog  = document.getElementById('sheetviewer');
  if (!dialog) { console.warn('[Lightbox] No dialog'); }
  else {
    const sheet   = dialog.querySelector('.sv-sheet');
    const reel    = dialog.querySelector('.sv-reel');
    const btnClose= dialog.querySelector('.sv-close');

    let items = [];    // [{src, alt, title, slug, srcs?[]}]
    let current = 0;
    let activeCat = '';

    /* Likes con meta timestamp (para Top 3 local) */
    const LS_KEY  = 'yoyu_favs';
    const LS_META = 'yoyu_favs_meta';

    const getFavs = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } };
    const setFavs = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(Array.from(new Set(arr))));
    const getMeta = () => { try{ return JSON.parse(localStorage.getItem(LS_META)||'{}'); }catch{ return {}; } };
    const setMeta = (obj) => localStorage.setItem(LS_META, JSON.stringify(obj));
    const isLiked = (slug) => getFavs().includes(slug);

    function toggleLike(slug){
      if (!slug) return false;
      const favs = new Set(getFavs());
      const meta = getMeta();
      let liked;
      if (favs.has(slug)) { favs.delete(slug); liked = false; if (meta[slug]) delete meta[slug]; }
      else { favs.add(slug); liked = true; meta[slug] = { likedAt: Date.now() }; }
      setFavs([...favs]); setMeta(meta);
      window.dispatchEvent(new CustomEvent('yoyu:favs-changed'));
      return liked;
    }

    const uniq = (arr) => Array.from(new Set(arr.filter(Boolean)));
    const findIndexBySlug = (slug) => (!slug ? -1 : items.findIndex(it => (it.slug||'')===slug));

    function slideHTML(it, idx){
      const title = it.title || it.alt || '';
      const liked = isLiked(it.slug||'');
      const carousel = uniq([it.src, ...(Array.isArray(it.srcs)? it.srcs: [])]);

      const view = (carousel.length > 1)
        ? `
          <div class="sv-view">
            <div class="sv-hstrip" data-strip>
              ${carousel.map(s => `
                <div class="sv-himg"><img src="${s}" alt="${it.alt||''}" loading="lazy" decoding="async"/></div>
              `).join('')}
            </div>
          </div>`
        : `
          <div class="sv-view">
            <div class="sv-single"><img src="${it.src}" alt="${it.alt||''}" loading="lazy" decoding="async"/></div>
          </div>`;

      return `
        <section class="sv-slide" data-idx="${idx}" data-slug="${it.slug||''}">
          <div class="sv-figure">
            ${view}
            <div class="sv-caption">
              <div class="cap-text" title="${title.replace(/"/g,'&quot;')}">${title}</div>
              <div class="cap-actions">
                <!-- ⤓ Ver entera (original) -->
                <button class="cap-btn cap-open" type="button" aria-label="Ver entera (original)" title="Ver entera (original)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M14 3h7v7"/><path d="M10 14 21 3"/><path d="M21 14v7h-7"/><path d="M3 10 14 21"/>
                  </svg>
                </button>
                <!-- ❤️ -->
                <button class="cap-btn cap-like${liked?' liked':''}" type="button" aria-label="Like" title="${liked?'Quitar de favoritos':'Añadir a favoritos'}">
                  <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12.1 21.35l-1.1-1.02C5.14 14.88 2 12.05 2 8.5 2 6 4 4 6.5 4c1.74 0 3.41.81 4.5 2.09C12.59 4.81 14.26 4 16 4 18.5 4 20.5 6 20.5 8.5c0 3.55-3.14 6.38-8.9 11.83l-.5.47z" fill="currentColor"/></svg>
                </button>
                <!-- ↗ Compartir -->
                <button class="cap-btn cap-share" type="button" aria-label="Compartir" title="Compartir">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"/><path d="M12 16V3"/><path d="M7 8l5-5 5 5"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </section>`;
    }

    function wireImageLoads(){
      const imgs = reel.querySelectorAll('.sv-view img');
      imgs.forEach(img => {
        if (img.complete) return;
        img.addEventListener('load', () => { if (img.closest('.sv-slide')?.dataset.idx == current) measureAndSetImgH(); }, { once:true });
      });
    }
    function renderSlides(){ reel.innerHTML = items.map(slideHTML).join(''); wireImageLoads(); }

    function measureAndSetImgH(){
      const slide = reel.querySelector(`.sv-slide[data-idx="${current}"]`); if (!slide) return;
      const headerH = dialog.querySelector('.sv-top')?.clientHeight || 0;
      const capH = slide.querySelector('.sv-caption')?.offsetHeight || 84;
      const avail = Math.max(240, dialog.querySelector('.sv-sheet').clientHeight - headerH - capH - 16);
      slide.querySelector('.sv-view')?.style.setProperty('--imgH', avail + 'px');
    }

    function scrollToIndex(idx, behavior='auto'){
      current = Math.max(0, Math.min(items.length - 1, Number(idx)||0));
      reel.querySelector(`.sv-slide[data-idx="${current}"]`)?.scrollIntoView({ behavior, block:'start' });
      updateHash(); syncLikeState();
      requestAnimationFrame(measureAndSetImgH);
    }

    function updateCurrentOnScroll(){
      const slides=[...reel.querySelectorAll('.sv-slide')]; if(!slides.length) return;
      const baseTop = reel.getBoundingClientRect().top; let idx=current, min=Infinity;
      for (let i=0;i<slides.length;i++){ const d=Math.abs(slides[i].getBoundingClientRect().top - baseTop); if(d<min){min=d; idx=i;} }
      if (idx!==current){ current=idx; updateHash(false); syncLikeState(); measureAndSetImgH(); }
    }

    function syncLikeState(){
      const slide = reel.querySelector(`.sv-slide[data-idx="${current}"]`); if(!slide) return;
      const slug = slide.dataset.slug || ''; const btn = slide.querySelector('.cap-like');
      btn?.classList.toggle('liked', isLiked(slug));
      btn?.setAttribute('title', isLiked(slug)?'Quitar de favoritos':'Añadir a favoritos');
    }

    function getCurrentImageSrc(slide){
      const strip = slide.querySelector('.sv-hstrip');
      if (strip){
        const imgs = [...strip.querySelectorAll('img')];
        if (!imgs.length) return null;
        const cX = strip.getBoundingClientRect().left + strip.clientWidth/2;
        let chosen = imgs[0], best = Infinity;
        for (const img of imgs){
          const r = img.getBoundingClientRect();
          const mid = r.left + r.width/2;
          const d = Math.abs(mid - cX);
          if (d < best){ best = d; chosen = img; }
        }
        return chosen.currentSrc || chosen.src || null;
      }
      const single = slide.querySelector('.sv-single img');
      return single?.currentSrc || single?.src || null;
    }

    function openFromTrigger(btn){
      const panel = btn.closest('.panel');
      if (panel?.dataset.items) { try{ items = JSON.parse(panel.dataset.items); }catch{ items = []; } activeCat = panel.dataset.cat || ''; }
      else { items = [{ src: btn.dataset.src, alt: btn.dataset.alt||'', title: btn.dataset.title||'', slug: btn.dataset.slug||'', srcs: [] }]; activeCat = document.querySelector('.tab.is-active')?.dataset.tab || ''; }
      if (!items.length) return;

      const slug = btn.dataset.slug || '';
      const idxFromSlug = findIndexBySlug(slug);
      const idxAttr = Number(btn.dataset.idx ?? 0);
      const startIdx = idxFromSlug >= 0 ? idxFromSlug : Math.max(0, Math.min(items.length-1, idxAttr));

      renderSlides();
      (dialog.showModal? dialog.showModal(): dialog.setAttribute('open','')); document.documentElement.style.overflow='hidden';
      requestAnimationFrame(() => { measureAndSetImgH(); requestAnimationFrame(() => scrollToIndex(startIdx,'auto')); });
    }

    async function shareCurrent(){
      const it = items[current] || {}; const slug=it.slug || String(current);
      const url = new URL(location.href); url.hash = `${activeCat}:${slug}`;
      try{
        if(navigator.share){ await navigator.share({ title:it.title||'Foto', url:url.toString() }); }
        else { await navigator.clipboard.writeText(url.toString()); alert('Enlace copiado'); }
      }catch{}
    }

    function close(){
      if (dialog.open && 'close' in dialog) dialog.close();
      dialog.removeAttribute('open'); document.documentElement.style.overflow='';
    }
    function updateHash(push = true){
      if (!activeCat) return;
      const it = items[current] || {}; const slugOrIdx = it.slug || String(current);
      if (push) history.replaceState(null,'','#'+activeCat+':'+slugOrIdx);
    }

    /* Delegación */
    document.addEventListener('click', (e) => {
      const trigger = e.target.closest('.lb-trigger'); if (trigger){ e.preventDefault(); openFromTrigger(trigger); return; }
    });
    reel.addEventListener('click', (e) => {
      const slide = e.target.closest('.sv-slide'); if (!slide) return;
      const slug = slide.dataset.slug || '';
      if (e.target.closest('.cap-like')){ const liked = toggleLike(slug); const b=slide.querySelector('.cap-like'); b?.classList.toggle('liked', liked); b?.setAttribute('title', liked?'Quitar de favoritos':'Añadir a favoritos'); return; }
      if (e.target.closest('.cap-share')){ e.preventDefault(); shareCurrent(); return; }
      if (e.target.closest('.cap-open')){ const src = getCurrentImageSrc(slide); if (src) window.open(src, '_blank', 'noopener,noreferrer'); return; }
    });

    reel.addEventListener('scroll', updateCurrentOnScroll, { passive:true });
    btnClose?.addEventListener('click', close);
    dialog.addEventListener('click', (e) => {
      const r = dialog.querySelector('.sv-sheet').getBoundingClientRect();
      const inside = e.clientX>=r.left && e.clientX<=r.right && e.clientY<=r.bottom && e.clientY>=r.top;
      if (!inside) close();
    });
    document.addEventListener('keydown', (e) => {
      if (!dialog.open) return;
      if (e.key === 'Escape') close();
      if (e.key === 'ArrowDown') { e.preventDefault(); reel.scrollBy({ top: dialog.querySelector('.sv-sheet').clientHeight, behavior:'smooth' }); }
      if (e.key === 'ArrowUp')   { e.preventDefault(); reel.scrollBy({ top:-dialog.querySelector('.sv-sheet').clientHeight, behavior:'smooth' }); }
      if (e.key.toLowerCase() === 'o'){ const slide = reel.querySelector(`.sv-slide[data-idx="${current}"]`); if (!slide) return; const src = getCurrentImageSrc(slide); if (src) window.open(src, '_blank', 'noopener,noreferrer'); }
    });

    function openFromHash(){
      const h = location.hash.replace('#',''); if (!h || !h.includes(':')) return;
      const [cat, rest] = h.split(':'); if (!cat || !rest) return;
      const panel = document.getElementById('panel-'+cat); if (!panel || !panel.dataset.items) return;
      activeCat = cat; try{ items = JSON.parse(panel.dataset.items); }catch{ items=[]; }
      if (!items.length) return;
      const idxBySlug = findIndexBySlug(rest);
      const startIdx = idxBySlug >= 0 ? idxBySlug : Math.max(0, parseInt(rest,10) || 0);
      renderSlides();
      (dialog.showModal? dialog.showModal(): dialog.setAttribute('open','')); document.documentElement.style.overflow='hidden';
      requestAnimationFrame(() => { measureAndSetImgH(); requestAnimationFrame(() => scrollToIndex(startIdx,'auto')); });
    }
    window.addEventListener('load', openFromHash);
    window.addEventListener('resize', () => requestAnimationFrame(measureAndSetImgH), { passive:true });
  }
</script>
