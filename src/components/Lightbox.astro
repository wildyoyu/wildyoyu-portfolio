---
/**
 * Visor vertical tipo Instagram (móvil-first):
 * - Abre como "hoja" a pantalla completa.
 * - Desliza ARRIBA/ABAJO para navegar por TODA la categoría sin cerrar.
 * - SIN flechas izquierda/derecha (todo es swipe/scroll vertical).
 * - Botones: "Ajustar/1:1" y "Compartir" (Web Share API o copia enlace).
 * - En desktop se centra; en móvil ocupa 100dvh. is:inline => no se hoistea.
 */
---
<dialog id="sheetviewer" class="sv" aria-label="Visor de imágenes">
  <div class="sv-backdrop" part="backdrop"></div>

  <div class="sv-sheet" role="document" aria-live="polite">
    <header class="sv-top">
      <button class="sv-close" aria-label="Cerrar" title="Cerrar">×</button>
      <div class="spacer"></div>
      <button class="sv-fit" aria-label="Cambiar tamaño" title="Ajustar / 1:1">Ajustar</button>
      <button class="sv-share" aria-label="Compartir" title="Compartir">↗</button>
    </header>

    <!-- Carril vertical de diapositivas (una por foto) -->
    <div class="sv-reel" tabindex="0" aria-live="polite"></div>
  </div>
</dialog>

<style>
  .sv { inset:0; border:0; padding:0; background:transparent; }
  .sv[open]{ display:grid; place-items:center; }
  .sv::backdrop{ background:rgba(0,0,0,.7); }
  .sv-backdrop{ position:fixed; inset:0; }

  .sv-sheet{
    position:relative;
    width:min(96vw, 1180px);
    height:min(96vh, 900px);
    background: rgba(12,14,16,.92);
    backdrop-filter: blur(6px);
    border-radius: 18px;
    outline: 1px solid rgba(255,255,255,.08);
    box-shadow: 0 30px 100px rgba(0,0,0,.5);
    overflow: hidden;
    display:grid; grid-template-rows: auto 1fr;
    touch-action: pan-y;
  }
  @media (max-width: 768px){
    .sv-sheet{ width:100vw; height:100dvh; border-radius: 0; }
  }

  .sv-top{
    display:flex; align-items:center; gap:8px;
    padding:10px; position:relative; z-index:2;
    background: linear-gradient(180deg, rgba(0,0,0,.35), transparent);
  }
  .sv-close, .sv-fit, .sv-share{
    min-width:42px; height:42px; padding:0 12px;
    border-radius: 999px; border:1px solid rgba(255,255,255,.2);
    background: rgba(0,0,0,.35); color:#fff; cursor:pointer;
    display:inline-flex; align-items:center; justify-content:center;
    backdrop-filter: blur(6px); font-weight:700;
  }
  .spacer{ flex:1; }

  /* Carril vertical "tipo stories feed" */
  .sv-reel{
    position:relative; height:100%;
    overflow-y:auto; overflow-x:hidden;
    scroll-snap-type: y mandatory;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-y: contain;
  }
  .sv-slide{
    position:relative;
    min-height: 100%; /* ocupa todo el alto visible */
    padding: clamp(10px, 2.2vw, 18px);
    display:flex; align-items:center; justify-content:center;
    scroll-snap-align: start;
  }

  /* Capción al pie (opcional) */
  .sv-cap{
    position:absolute; left:0; right:0; bottom:8px;
    text-align:center; opacity:.85; padding: 0 12px;
  }

  /* Modos de ajuste */
  .sv.mode-fit .sv-img{ max-width: 100%; max-height: 100%; width:auto; height:auto; }
  .sv.mode-original .sv-slide{ overflow:auto; } /* permite pan interno */
  .sv.mode-original .sv-img{ max-width: none; max-height: none; width:auto; height:auto; }

  .sv-img{
    display:block; user-select:none; -webkit-user-drag:none;
    transition: transform .25s ease, opacity .25s ease;
    will-change: transform;
  }

  /* Evita "pegotes" al arrastrar */
  .dragging .sv-img{ transition: none; }
</style>

<script is:inline>
  const dialog  = document.getElementById('sheetviewer');
  if (!dialog) { console.warn('[SheetViewer] No se encontró el dialog.'); }
  else {
    const sheet   = dialog.querySelector('.sv-sheet');
    const reel    = dialog.querySelector('.sv-reel');
    const btnClose= dialog.querySelector('.sv-close');
    const btnFit  = dialog.querySelector('.sv-fit');
    const btnShare= dialog.querySelector('.sv-share');

    let items = [];     // [{src, alt, title, slug}]
    let current = 0;
    let activeCat = ''; // 'wildlife' | 'macro' | 'night'
    let mode = 'fit';   // 'fit' (ajustar) | 'original' (1:1)
    let holdTimer = null;

    const isMobile = () => matchMedia('(max-width: 768px)').matches;

    function applyMode(){
      dialog.classList.toggle('mode-fit', mode === 'fit');
      dialog.classList.toggle('mode-original', mode === 'original');
      btnFit.textContent = (mode === 'fit') ? 'Ajustar' : '1:1';
      btnFit.title = (mode === 'fit') ? 'Ajustado a visor' : 'Tamaño original';
    }

    function renderSlides(){
      reel.innerHTML = items.map((it, idx) => `
        <section class="sv-slide" data-idx="${idx}">
          <img class="sv-img" src="${it.src}" alt="${it.alt || ''}" />
          ${it.title ? `<div class="sv-cap">${it.title}</div>` : ''}
        </section>
      `).join('');
    }

    function scrollToIndex(idx, behavior = 'instant'){
      current = Math.max(0, Math.min(items.length - 1, idx));
      const slideH = sheet.clientHeight - (dialog.querySelector('.sv-top')?.clientHeight || 0);
      reel.scrollTo({ top: current * slideH, behavior });
      updateHash();
    }

    function updateCurrentOnScroll(){
      const slideH = sheet.clientHeight - (dialog.querySelector('.sv-top')?.clientHeight || 0);
      const idx = Math.round(reel.scrollTop / Math.max(1, slideH));
      if (idx !== current){ current = idx; updateHash(false); }
    }

    function openFromTrigger(btn){
      // Encuentra el panel (categoría) y carga su dataset.items
      const panel = btn.closest('.panel');
      if (panel?.dataset.items) {
        try {
          items = JSON.parse(panel.dataset.items);
        } catch {
          items = [];
        }
        activeCat = panel.dataset.cat || '';
      } else {
        // Fallback: solo esa imagen
        items = [{ src: btn.dataset.src, alt: btn.dataset.alt || '', title: btn.dataset.title || '', slug: btn.dataset.slug || '' }];
        activeCat = document.querySelector('.tab.is-active')?.dataset.tab || '';
      }
      if (!items.length) return;

      // índice de la miniatura pulsada
      const startIdx = Number(btn.dataset.idx ?? 0);

      // Móvil abre en "fit", desktop puede abrir en original si quieres
      mode = isMobile() ? 'fit' : 'fit'; // cambia a 'original' para desktop si lo prefieres
      applyMode();

      renderSlides();
      if ('showModal' in dialog) dialog.showModal(); else { dialog.setAttribute('open',''); }
      document.documentElement.style.overflow = 'hidden';

      // Posiciona en la slide correcta
      requestAnimationFrame(() => scrollToIndex(startIdx, 'instant'));
    }

    async function shareCurrent(){
      const it = items[current] || {};
      // Enlace canónico: /gallery#<cat>:<slug|idx>
      const slugOrIdx = it.slug || String(current);
      const url = new URL(location.href);
      url.hash = `${activeCat}:${slugOrIdx}`;
      const shareUrl = url.toString();

      try{
        if (navigator.share){
          await navigator.share({ title: it.title || 'Foto', url: shareUrl });
        } else {
          await navigator.clipboard.writeText(shareUrl);
          alert('Enlace copiado al portapapeles');
        }
      }catch{}
    }

    function close(){
      if (dialog.open && 'close' in dialog) dialog.close();
      dialog.removeAttribute('open');
      document.documentElement.style.overflow = '';
    }

    function updateHash(push = true){
      if (!activeCat) return;
      const it = items[current] || {};
      const slugOrIdx = it.slug || String(current);
      const newHash = `${activeCat}:${slugOrIdx}`;
      if (push) history.replaceState(null, '', '#' + newHash);
      else if (location.hash.replace('#','') !== newHash) history.replaceState(null, '', '#' + newHash);
    }

    // Delegación: click y "long press" en miniaturas .lb-trigger
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.lb-trigger');
      if (!btn) return;
      e.preventDefault();
      openFromTrigger(btn);
    });
    document.addEventListener('pointerdown', (e) => {
      const btn = e.target.closest('.lb-trigger');
      if (!btn) return;
      holdTimer = setTimeout(() => { openFromTrigger(btn); }, 400);
    });
    document.addEventListener('pointerup',   () => { if (holdTimer) { clearTimeout(holdTimer); holdTimer = null; } });
    document.addEventListener('pointercancel',() => { if (holdTimer) { clearTimeout(holdTimer); holdTimer = null; } });

    // Botones
    btnClose?.addEventListener('click', close);
    btnFit?.addEventListener('click', () => { mode = (mode === 'fit') ? 'original' : 'fit'; applyMode(); });
    btnShare?.addEventListener('click', shareCurrent);

    // Scroll → actualizar índice
    reel.addEventListener('scroll', () => { updateCurrentOnScroll(); }, { passive: true });

    // Clic fuera para cerrar
    dialog.addEventListener('click', (e) => {
      const r = sheet.getBoundingClientRect();
      const inside = e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom;
      if (!inside) close();
    });

    // Teclado
    document.addEventListener('keydown', (e) => {
      if (!dialog.open) return;
      if (e.key === 'Escape') close();
      if (e.key.toLowerCase() === 'f') { mode = (mode === 'fit') ? 'original' : 'fit'; applyMode(); }
      if (e.key.toLowerCase() === 's') shareCurrent();
      // Arriba/abajo para navegar (útil en desktop)
      if (e.key === 'ArrowDown') scrollToIndex(current + 1, 'smooth');
      if (e.key === 'ArrowUp')   scrollToIndex(current - 1, 'smooth');
    });

    // Abrir directo por URL: /gallery#macro:slug
    function openFromHash(){
      const h = location.hash.replace('#','');
      if (!h) return;
      const [cat, rest] = h.split(':');
      if (!cat) return;
      const panel = document.getElementById('panel-' + cat);
      if (!panel || !panel.dataset.items) return;
      activeCat = cat;
      try { items = JSON.parse(panel.dataset.items); } catch { items = []; }
      if (!items.length) return;

      const idx = items.findIndex(x => (x.slug && rest && x.slug === rest));
      const startIdx = idx >= 0 ? idx : Math.max(0, parseInt(rest, 10) || 0);

      mode = isMobile() ? 'fit' : 'fit';
      applyMode();
      renderSlides();
      if ('showModal' in dialog) dialog.showModal(); else { dialog.setAttribute('open',''); }
      document.documentElement.style.overflow = 'hidden';
      requestAnimationFrame(() => scrollToIndex(startIdx, 'instant'));
    }
    window.addEventListener('load', openFromHash);

    // Liberar scroll siempre al cerrar
    dialog.addEventListener('close', () => { document.documentElement.style.overflow=''; });
    dialog.addEventListener('cancel', (e)=>{ e.preventDefault(); dialog.close(); });
    console.info('[SheetViewer] listo ✓');
  }
</script>
