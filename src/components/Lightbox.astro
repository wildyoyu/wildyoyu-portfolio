---
/**
 * Visor minimal 1:1 (imagen pequeña) con UI FIJA:
 *  - Cuadro 1:1 centrado (por defecto 300px)
 *  - Título fijo arriba-CENTRADO (bajado ~3–4 cm)
 *  - Botones fijos abajo, centrados
 *  - Sin “X”; cerrar con clic fuera o ESC
 */
---
<dialog id="sheetviewer" class="sv" aria-label="Visor de imagen">
  <div class="sv-stage">
    <!-- UI fija superior (título centrado) -->
    <figcaption id="sv-title" class="sv-caption" hidden></figcaption>

    <!-- Imagen 1:1 centrada -->
    <figure class="sv-figure" aria-live="polite">
      <div class="square-box">
        <img id="sv-img" src="" alt="" loading="eager" decoding="async" />
      </div>
    </figure>

    <!-- UI fija inferior (acciones) -->
    <div class="sv-actions" role="group" aria-label="Acciones">
      <button class="act-btn sv-open" type="button" aria-label="Ver entera (original)" title="Ver entera (original)">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <polyline points="14,3 21,3 21,10" />
          <polyline points="10,14 21,3" />
          <polyline points="21,14 21,21 14,21" />
          <polyline points="3,10 14,21" />
        </svg>
      </button>
      <button class="act-btn sv-share" type="button" aria-label="Compartir" title="Compartir">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"/>
          <path d="M12 16V3"/>
          <polyline points="7,8 12,3 17,8"/>
        </svg>
      </button>
    </div>
  </div>
</dialog>

<style>
  /* Backdrop */
  .sv{ inset:0; border:0; padding:0; background:transparent; }
  .sv[open]{ display:block; }
  .sv::backdrop{ background: rgba(0,0,0,.82); }

  /* Escenario fullscreen */
  .sv-stage{
    position: fixed; inset: 0;
    display: grid; place-items: center;
    pointer-events: none;
  }

  /* Cuadro 1:1 pequeño */
  :root{
    --sq: 420px;        /* tamaño del cuadro 1:1 */
    --cap-top: 40px;   /* ≈3.4 cm; sube/baja si quieres */
  }
  .square-box{
    position: relative;
    aspect-ratio: 1 / 1;
    width: var(--sq); height: var(--sq);
    display:grid; place-items:center;
    overflow: visible;
    pointer-events: auto;
  }
  .sv-figure{
    margin:0; display:grid; place-items:center;
    pointer-events: auto;
  }
  #sv-img{
    width: 100%; height: 100%;
    object-fit: contain;
    display:block; border:0; border-radius:0; box-shadow:none; background: transparent;
  }

  /* === UI FIJA === */

  /* Título fijo ARRIBA-CENTRADO — estilo profesional y más pequeño */
  .sv-caption{
    position: fixed; top: var(--cap-top); left: 50%; transform: translateX(-50%);
    z-index: 10; text-align: center;

    /* Tipografía elegante y contenida */
    font-family: "Newsreader Variable", InterVariable, serif;
    font-weight: 700;
    font-variation-settings: "opsz" 18;
    font-size: clamp(.82rem, 1.2vw, .95rem);
    line-height: 1.2;
    letter-spacing: .1px;

    /* Pastilla sutil y legible */
    background: color-mix(in oklab, var(--bg1) 74%, white 6%);
    color: var(--fg);
    -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
    border: 1px solid color-mix(in oklab, var(--fg) 12%, transparent);
    border-radius: 10px;
    padding: 6px 10px;
    max-width: min(80vw, 60ch);

    pointer-events: none; /* no bloquea clics */
  }

  /* Botones fijos ABAJO-CENTRADOS */
  .sv-actions{
    position: fixed; left: 50%; transform: translateX(-50%);
    bottom: 20px; z-index: 10;
    display:flex; gap:10px; justify-content:center;
    background: color-mix(in oklab, var(--bg0) 35%, transparent);
    -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
    border: 1px solid var(--stroke); border-radius: 999px;
    padding:6px; box-shadow: 0 10px 22px rgba(0,0,0,.32);
    pointer-events: auto;
  }
  .act-btn{
    all:unset; box-sizing:border-box; width:42px; height:42px; border-radius:9999px;
    background: #ffffffeb; color: #0b0f0d;
    border: 1px solid color-mix(in oklab, #000 16%, transparent);
    display:grid; place-items:center; cursor:pointer; line-height:0;
    box-shadow: 0 6px 16px rgba(0,0,0,.24);
  }
  .act-btn:hover{ transform: translateY(-1px); }
  .act-btn svg{ width:22px; height:22px; display:block; stroke: currentColor; fill: none; stroke-width:2.3; stroke-linecap:round; stroke-linejoin:round; }
</style>

<script is:inline>
  const dialog  = document.getElementById('sheetviewer');
  if (!dialog) { console.warn('[Lightbox] No dialog'); }
  else {
    const img     = dialog.querySelector('#sv-img');
    const titleEl = dialog.querySelector('#sv-title');

    let current = { src:'', alt:'', title:'', slug:'', category:'' };

    function openFromTrigger(btn){
      current = {
        src: btn.dataset.src || '',
        alt: btn.dataset.alt || '',
        title: btn.dataset.title || '',
        slug: btn.dataset.slug || '',
        category: (btn.closest('.panel')?.dataset.cat) || document.querySelector('.tab.is-active')?.dataset.tab || ''
      };
      img.src = current.src;
      img.alt = current.alt || current.title || 'Foto';
      if (current.title){ titleEl.textContent = current.title; titleEl.hidden = false; } else { titleEl.hidden = true; }

      (dialog.showModal ? dialog.showModal() : dialog.setAttribute('open',''));
      document.documentElement.style.overflow='hidden';
    }

    async function shareCurrent(){
      try{
        const url = new URL(location.href);
        if (current.slug && current.category) url.hash = `${current.category}:${current.slug}`;
        if(navigator.share){ await navigator.share({ title: current.title || 'Foto', url: url.toString() }); }
        else { await navigator.clipboard.writeText(url.toString()); alert('Enlace copiado'); }
      }catch{}
    }
    function openOriginal(){ if (current.src) window.open(current.src, '_blank', 'noopener,noreferrer'); }
    function close(){
      if (dialog.open && 'close' in dialog) dialog.close();
      dialog.removeAttribute('open');
      document.documentElement.style.overflow='';
    }

    // Abrir desde miniatura y acciones
    document.addEventListener('click', (e) => {
      const trigger = e.target.closest('.lb-trigger');
      if (trigger){ e.preventDefault(); openFromTrigger(trigger); return; }

      if (!dialog.open) return;
      if (e.target.closest('.sv-share')) { e.preventDefault(); shareCurrent(); return; }
      if (e.target.closest('.sv-open'))  { e.preventDefault(); openOriginal();   return; }
    });

    // Cerrar con clic fuera del cuadrado/botones o con ESC
    dialog.addEventListener('click', (e) => {
      const fig = dialog.querySelector('.sv-figure').getBoundingClientRect();
      const inside = e.clientX>=fig.left && e.clientX<=fig.right && e.clientY>=fig.top && e.clientY<=fig.bottom;
      const onControls = e.target.closest('.sv-actions') || e.target.closest('.square-box') || e.target.closest('.sv-caption');
      if (!onControls && !inside) close();
      if (inside && !onControls) close();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
  }
</script>
