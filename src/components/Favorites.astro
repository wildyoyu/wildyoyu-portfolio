---
import { getCollection } from 'astro:content';

const all = await getCollection('shots');
const index = all.map(e => ({
  slug: e.slug,
  title: e.data.title,
  alt: e.data.alt,
  src: e.data.src,
  category: (e.data.category || '').toLowerCase(),
  w: e.data.w, h: e.data.h
}));
const DEBUG = false; // cambia a true temporalmente si quieres ver diagnóstico en consola
---
<section class="section" id="favs">
  <div class="container">
    <h2 class="h2" style="margin-bottom:.4rem;">Favoritos de los Yoyus</h2>
    <p class="lead" id="favs-count" style="opacity:.85; margin:0 0 .8rem 0;">Aún no hay favoritos. Dale ❤️ a tus fotos.</p>

    <!-- Top 3 -->
    <div id="favs-top" class="favs-top" aria-label="Top 3"></div>

    <!-- Todos -->
    <div id="favs-grid" class="favs-grid" style="margin-top:10px"></div>

    <script type="application/json" id="shots-index">{JSON.stringify(index)}</script>
  </div>

  <style>
    .favs-top{
      display:grid; gap:8px;
      grid-template-columns: repeat(3, 1fr);
      margin-bottom: 8px;
    }
    .favs-grid{
      display:grid; gap:6px;
      grid-template-columns: repeat(3, 1fr);
    }
    @media (min-width: 681px){ .favs-grid{ grid-template-columns: repeat(6, 1fr); } }
    @media (min-width: 1025px){ .favs-grid{ grid-template-columns: repeat(8, 1fr); } }

    .tile{ position:relative; overflow:hidden; border-radius:8px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); }
    .tile a{ display:block; }
    .tile img{ width:100%; height:100%; object-fit:cover; display:block; aspect-ratio:1/1; }
    .badge {
      position:absolute; right:6px; top:6px;
      padding:.15rem .45rem; border-radius:999px;
      font-size:12px; font-weight:800;
      background:rgba(255,255,255,.9); color:#111;
      border:1px solid #e5e7eb;
    }
  </style>

  <script is:inline>
    // ===== Carga índice =====
    const idxEl = document.getElementById('shots-index');
    /** @type {{slug:string,title?:string,alt?:string,src:string,category?:string}[]} */
    let shots = [];
    try { shots = JSON.parse(idxEl?.textContent || '[]'); } catch { shots = []; }
    const bySlug = new Map(shots.map(s => [s.slug, s]));

    const grid    = document.getElementById('favs-grid');
    const top3    = document.getElementById('favs-top');
    const counter = document.getElementById('favs-count');

    const LS_KEY  = 'yoyu_favs';
    const LS_META = 'yoyu_favs_meta';

    const getRawFavs = () => { try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } };
    const getMeta    = () => { try{ return JSON.parse(localStorage.getItem(LS_META)||'{}'); }catch{ return {}; } };

    // Normaliza claves antiguas: admite "cat:slug", rutas con "/", etc.
    function normalizeKeys(){
      const favArr = getRawFavs();
      const meta   = getMeta();
      const merged = [...favArr, ...Object.keys(meta||{})].filter(Boolean);
      const uniq   = Array.from(new Set(merged));

      return uniq.map(k => {
        // casos: "wildlife:ojo-compuesto", "/gallery#wildlife:ojo-compuesto", "shots/ojo-compuesto"
        if (k.includes('#')) k = k.split('#').pop();
        if (k.includes(':')) k = k.split(':').pop();
        if (k.includes('/')) k = k.split('/').pop();
        return k;
      });
    }

    function mapToShots(keys){
      const hits = [];
      const misses = [];
      for (const k of keys){
        const s = bySlug.get(k);
        if (s) hits.push(s); else misses.push(k);
      }
      if (DEBUG && misses.length){
        console.info('[Favs] Slugs sin match (probable renombre):', misses);
        console.info('[Favs] Slugs disponibles:', [...bySlug.keys()]);
      }
      return hits;
    }

    function render(){
      const keys = normalizeKeys();
      const meta = getMeta();
      const favs = mapToShots(keys)
        .map(s => ({...s, likedAt: meta[s.slug]?.likedAt || 0}))
        .sort((a,b) => b.likedAt - a.likedAt);

      counter.textContent = favs.length
        ? `Tus favoritos (${favs.length})`
        : 'Aún no hay favoritos. Dale ❤️ a tus fotos.';

      const top = favs.slice(0,3);
      top3.innerHTML = top.map((f, i) => `
        <div class="tile">
          <a href="/gallery#${f.category||'wildlife'}:${f.slug}" title="${(f.title||'').replace(/"/g,'&quot;')}">
            <img src="${f.src}" alt="${(f.alt||'').replace(/"/g,'&quot;')}" loading="lazy" decoding="async"/>
          </a>
          <span class="badge">TOP ${i+1}</span>
        </div>
      `).join('');

      grid.innerHTML = favs.map(f => `
        <div class="tile">
          <a href="/gallery#${f.category||'wildlife'}:${f.slug}" title="${(f.title||'').replace(/"/g,'&quot;')}">
            <img src="${f.src}" alt="${(f.alt||'').replace(/"/g,'&quot;')}" loading="lazy" decoding="async"/>
          </a>
        </div>
      `).join('');
    }

    render();
    // Se actualiza si likeas en otra pestaña o si el visor emite el evento custom
    window.addEventListener('storage', (e) => { if (e.key===LS_KEY || e.key===LS_META) render(); });
    window.addEventListener('yoyu:favs-changed', render);

    if (DEBUG){
      console.info('[Favs] index size:', shots.length);
      console.info('[Favs] raw favs:', getRawFavs());
      console.info('[Favs] meta:', getMeta());
    }
  </script>
</section>
