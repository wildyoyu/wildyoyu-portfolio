---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const all = await getCollection("shots");

function itemsBy(cat) {
  return all
    .filter((e) => (e.data.category || "").toLowerCase() === cat)
    .sort((a, b) => new Date(b.data.date || 0).getTime() - new Date(a.data.date || 0).getTime())
    .map((e) => ({
      slug: e.slug,
      src: e.data.src,
      srcs: e.data.srcs || [],
      alt: e.data.alt,
      title: e.data.title,
      w: e.data.w, h: e.data.h
    }));
}

const tabs = [
  { id: "wildlife", title: "Wildlife", items: itemsBy("wildlife") },
  { id: "macro",    title: "Macro space", items: itemsBy("macro") },
  { id: "night",    title: "Night moments", items: itemsBy("night") },
];
---
<BaseLayout title="Galería — Wildyoyu" description="Wildlife, Macro y Night">
  <section class="section">
    <div class="container">
      <div class="tabs" role="tablist">
        {tabs.map((t, i) => (
          <button class={`tab${i===0?' is-active':''}`} data-tab={t.id} aria-selected={i===0?'true':'false'} aria-controls={`panel-${t.id}`} id={`tab-${t.id}`} type="button">
            {t.title}
          </button>
        ))}
      </div>

      {tabs.map((t, i) => (
        <div id={`panel-${t.id}`} class={`panel${i===0?' is-active':''}`} role="tabpanel" aria-labelledby={`tab-${t.id}`}
             data-cat={t.id}
             data-items={JSON.stringify(t.items)}>
          {t.items.length === 0 ? (
            <p class="lead">Aún no hay fotos en {t.title.toLowerCase()}.</p>
          ) : (
            <div class="ig-grid">
              {t.items.map((it, idx) => (
                <article class="tile">
                  <button class="lb-trigger" type="button"
                          data-idx={idx} data-slug={it.slug}
                          data-src={it.src} data-alt={it.alt} data-title={it.title}
                          data-w={it.w} data-h={it.h}>
                    <div class="thumb"><img src={it.src} alt={it.alt} loading="lazy" decoding="async" /></div>
                  </button>
                </article>
              ))}
            </div>
          )}
        </div>
      ))}
    </div>
  </section>

  <style>
    .panel{display:none} .panel.is-active{display:block}
  </style>

  <script is:inline>
    const ids = ['wildlife','macro','night'];
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const panels = ids.map(id=>document.getElementById('panel-'+id));
    function activate(id){
      tabs.forEach(b=>{const on=b.dataset.tab===id; b.classList.toggle('is-active',on); b.setAttribute('aria-selected',on?'true':'false');});
      panels.forEach(p=>p?.classList.toggle('is-active', p.id==='panel-'+id));
      history.replaceState(null,'','#'+id);
    }
    const init = (location.hash.replace('#','')||'').split(':')[0];
    activate(ids.includes(init)?init:ids[0]);
    tabs.forEach(b=>b.addEventListener('click',()=>activate(b.dataset.tab)));
  </script>
</BaseLayout>
