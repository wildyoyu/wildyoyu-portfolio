---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Todas las fotos por categoría, sin límite
const all = await getCollection('shots');

function itemsBy(cat) {
  return all
    .filter((e) => (e.data.category || '').toLowerCase() === cat)
    .sort((a, b) => {
      const da = a.data.date ? new Date(a.data.date).getTime() : 0;
      const db = b.data.date ? new Date(b.data.date).getTime() : 0;
      return db - da;
    })
    .map((e) => ({ slug: e.slug, srcs: e.data.srcs ?? [], ...e.data }));
}

const tabs = [
  { id: 'wildlife', title: 'Wildlife',     items: itemsBy('wildlife') },
  { id: 'macro',    title: 'Macro space',  items: itemsBy('macro') },
  { id: 'night',    title: 'Night moments',items: itemsBy('night') },
];
---
<BaseLayout title="Galería — Wildyoyu" description="Explora por secciones: Wildlife, Macro y Night">
  <section class="section">
    <div class="container gallery-root">
      <!-- Pestañas -->
      <div class="tabs" role="tablist" aria-label="Secciones de galería">
        {tabs.map((t, i) => (
          <button
            class={`tab${i===0 ? ' is-active' : ''}`}
            data-tab={t.id}
            role="tab"
            aria-selected={i===0 ? 'true' : 'false'}
            aria-controls={`panel-${t.id}`}
            id={`tab-${t.id}`}
            type="button"
          >
            {t.title}
          </button>
        ))}
      </div>

      <!-- Paneles: rejilla 3×N con recorte áureo horizontal -->
      <div class="panels">
        {tabs.map((t, i) => (
          <div
            id={`panel-${t.id}`}
            class={`panel${i===0 ? ' is-active' : ''}`}
            role="tabpanel"
            aria-labelledby={`tab-${t.id}`}
          >
            {t.items.length === 0 ? (
              <p class="lead">Aún no hay fotos en {t.title.toLowerCase()}.</p>
            ) : (
              <div class="ig-grid">
                {t.items.map((it) => {
                  const hasCarousel = it.srcs && it.srcs.length > 0;
                  const list = hasCarousel ? JSON.stringify([it.src, ...it.srcs]) : undefined;
                  return (
                    <article class="tile">
                      <button
                        class="lb-trigger"
                        type="button"
                        aria-label={`Abrir ${it.title} a pantalla completa`}
                        data-src={it.src}
                        data-srcs={list}
                        data-alt={it.alt}
                        data-title={it.title}
                        title={it.title}
                      >
                        <div class="thumb">
                          <img
                            src={it.src}
                            alt={it.alt}
                            loading="lazy"
                            width={it.w}
                            height={it.h}
                          />
                        </div>
                        {hasCarousel ? (
                          <span class="badge-multi" aria-label="Carrusel" title="Carrusel">
                            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                              <rect x="5" y="5" width="10" height="10" rx="2" fill="currentColor" opacity=".85"/>
                              <rect x="9" y="9" width="10" height="10" rx="2" fill="currentColor"/>
                            </svg>
                          </span>
                        ) : null}
                      </button>
                      {/* OJO: no ponemos <a href="/photo/..."> para evitar rutas dinámicas */}
                    </article>
                  );
                })}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  </section>

  <style>
    .gallery-root{ --phi: 1.618; }

    /* Tabs */
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .tab{
      cursor:pointer; padding:.6rem .9rem; border-radius:999px; font-weight:700;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      color: var(--fg);
    }
    .tab.is-active{ background: var(--fg); color: var(--bg); border-color: transparent; }

    /* Paneles */
    .panels{ position:relative;min-height: 0; }
    .panel{ display:none; animation: fade .2s ease both; }
    .panel.is-active{ display:block; }
    @keyframes fade{ from{opacity:.7; transform:translateY(-4px);} to{opacity:1; transform:none;} }

    /* Rejilla Instagram: 3 columnas SIEMPRE */
    .ig-grid{
  display:grid !important;
  grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
  gap: 6px;
  align-items: stretch;
  contain: layout paint;          /* evita reflows grandes al cargar imágenes */
}

    .tile{
      position:relative; overflow:hidden; border-radius: 8px;
      background: rgba(255,255,255,.04);
    }
    .tile .lb-trigger{
      display:block; position:relative; padding:0; margin:0; border:0; background:none; cursor:zoom-in; width:100%;
    }

    /* Wrapper que IMPONE el recorte áureo */
    .thumb{
  width:100%;
  aspect-ratio: 1.618 / 1;
  overflow:hidden;
  border-radius: 8px;
}
    .thumb img{
      width:100%; height:100%;
      object-fit: cover; object-position: center;
      display:block;
    }

    /* Indicador de carrusel */
    .badge-multi{
      position:absolute; top:8px; right:8px;
      display:inline-grid; place-items:center;
      width:26px; height:26px; border-radius:999px;
      background: rgba(0,0,0,.45); color:#fff;
      backdrop-filter: blur(6px);
    }

    .lead{ opacity:.9; }
  </style>

  <script type="module">
    // Tabs con hash (#wildlife|#macro|#night)
    const ids = ['wildlife','macro','night'];
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const panels = ids.map(id => document.getElementById('panel-' + id));

    function activate(id){
      tabs.forEach(btn => {
        const on = btn.dataset.tab === id;
        btn.classList.toggle('is-active', on);
        btn.setAttribute('aria-selected', on ? 'true' : 'false');
      });
      panels.forEach(p => p?.classList.toggle('is-active', p.id === 'panel-' + id));
      history.replaceState(null, '', '#' + id);
    }

    const initHash = location.hash.replace('#','');
    activate(ids.includes(initHash) ? initHash : ids[0]);

    tabs.forEach(btn => btn.addEventListener('click', () => activate(btn.dataset.tab)));
  </script>
</BaseLayout>
